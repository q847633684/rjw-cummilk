# 从注射药物到泌乳结束：逻辑梳理、优化建议与扩展思路

本文档按「注射/服用 → 吸收延迟 → 水池 L → 耐受 → 泌乳结束」做端到端逻辑梳理，并给出优化建议与 RimWorld/RJW 可扩展的泌乳相关内容（扩散思维）。

---

## 一、端到端逻辑链

### 1.1 入口：注射/服用

| 步骤 | 位置 | 行为 |
|------|------|------|
| 玩家/AI 选择「注射催乳素」等 | 浮窗 / Job | `JobDriver_InjectLactatingDrug`：取药 → 走到目标 → `InjectIngestible`（延迟 baseIngestTicks）→ `Toils_Ingest.FinalizeIngest` |
| 原版 FinalizeIngest | RimWorld | 调用药品 ThingDef 的 `ingestible.outcomeDoers` 依次执行 |
| XML outcomeDoers | Defs | 典型顺序：① `IngestionOutcomeDoer_GiveHediff`(Lactating, severity 0.5/2.0) ② 同类型 GiveHediff(EM_Prolactin_Tolerance, +0.044 等) ③ 化学 Need 等。**耐受、成瘾、Need 由原版 + XML 完全接管**。 |

### 1.2 拦截：吸收延迟与水池进水

| 步骤 | 位置 | 行为 |
|------|------|------|
| Harmony Postfix | `Milking.cs` → `ProlactinAddictionPatch.DoIngestionOutcome_Postfix` | 仅当 `hediffDef == HediffDefOf.Lactating` 时触发。**先移除刚加的 Lactating**，计算吃药前耐受 `t_before = max(0, 当前耐受 - 0.044)`，rawSeverity = 本剂 Lactating severity。 |
| 分支 A：有 World | `WorldComponent_EqualMilkingAbsorptionDelay` | `ScheduleLactating(pawn, rawSeverity, endTick, toleranceBefore)` 入队；给 pawn 挂 `EM_AbsorptionDelay` Hediff（若没有）。endTick = 当前 tick + `GetAbsorptionDelayTicks(pawn)`（由代谢率 clamp 0.25~2 决定，基准 0.25 游戏日）。 |
| 分支 B：无 World | 同文件 postfix 内 | 立即算 Δs = rawSeverity × E_tol(t_before)，重新 `GetOrAddHediff(Lactating)` 并 `comp.AddFromDrug(Δs)`，再 `ApplyProlactinMoodEffects`。 |
| WorldComponent 每 tick | `WorldComponent_EqualMilkingAbsorptionDelay.WorldComponentTick` | 遍历 pending，若 `now >= endTick`：移除该条、移除 EM_AbsorptionDelay、`ApplyDelayedLactating(pawn, rawSeverity, toleranceBefore)` → Δs = rawSeverity × E_tol(toleranceBefore)，GetOrAddHediff(Lactating) + comp.AddFromDrug(Δs)，ApplyProlactinMoodEffects。 |

### 1.3 水池 L 与双池

| 步骤 | 位置 | 行为 |
|------|------|------|
| 进水 | `HediffComp_EqualMilkingLactating.AddFromDrug(deltaSeverity)` | `currentLactationAmount += deltaSeverity * DoseToLFactor`（C_dose=1）。 |
| 每日衰减 | `HediffComp_EqualMilkingLactating.CompPostTick`（每 200 tick） | 若非永久泌乳基因/动物常开：`dailyDecay = D(L,E)*step`，L -= dailyDecay；若 L < LactationEndEpsilon 则 L=0 并 `ResetAndRemoveLactating()`。 |
| 泌乳结束 | `ResetAndRemoveLactating` | L=0，`CompEquallyMilkable.ClearPools()`，`Pawn.health.RemoveHediff(parent)`（移除 Lactating）。 |
| 双池进水 | `CompEquallyMilkable.UpdateMilkPools`（每 30 tick） | 流速 ∝ L × 饥饿系数 × 流速倍率，左右池各分一半；满则溢出、回缩等（见《耐受与水池系统说明》）。 |

### 1.4 耐受与药物副作用（由游戏接管）

| 项目 | 说明 |
|------|------|
| 耐受增加 | XML：每次服 Prolactin +0.044、Lucilactin +0.176（divideByBodySize）；由原版 IngestionOutcomeDoer 执行。 |
| 耐受衰减 | XML：`EM_Prolactin_Tolerance` 上 `HediffCompProperties_SeverityPerDay` = -0.015/日。 |
| 成瘾/Need | ChemicalDef + NeedDef + 原版 Need_Chemical；戒断、满足心情等由游戏驱动。 |
| 药效系数 E_tol | 本 mod 只读耐受严重度 t，在**进水时**用 `GetProlactinToleranceFactor(t_before)` 算 Δs，不再在 XML 侧重复削弱（避免平方）。 |

### 1.5 心情与 Hediff 联动

| 时机 | 行为 |
|------|------|
| 药物生效时（延迟到点 / 立即） | `ApplyProlactinMoodEffects`：给 `EM_Prolactin_Joy` 记忆；若 severity≥2 则挂/刷新 `EM_Prolactin_High`（Severity≥1）。 |
| 挤奶时 | 若 `HasDrugInducedLactation()` 且存在 `EM_Prolactin_Joy`，给生产者 `TryGainMemory(EM_Prolactin_Joy)`。 |
| 药物泌乳负担/增益 | `CompEquallyMilkable.ApplyDrugInducedLactationEffects`（每 30 tick）：若「正在泌乳且 HasDrugInducedLactation」则挂 EM_DrugLactationBurden、EM_LactatingGain（在设置开启时）；否则移除。 |

### 1.6 小结：关键数据流

```
服药 → outcomeDoers 加 Lactating + 耐受
  → Postfix 移除 Lactating，算 t_before、rawSeverity
  → 入队(endTick) 或立即 Δs = rawSeverity×E_tol(t_before)
  → 到点/立即：GetOrAddHediff(Lactating) + AddFromDrug(Δs) + 心情
  → L 每 200 tick 衰减；L≤0 → 移除 Lactating、清双池
  → 双池每 30 tick 由 L 进水，挤奶/吸奶从双池取
```

---

## 二、发现与优化建议

### 2.1 死代码 / 未使用逻辑

- **DrugEffectSystemFix**（`EqualMilking.cs`）：`CalculateCumulativeProduction`、`ApplyExponentialDecay`、`CalculateDecayedEffect` 等**未被任何调用**。当前进水与衰减已由水池公式与 `GetProlactinToleranceFactor` 统一处理。
  - **建议**：若未来不做「递减累加/指数衰减」新模型，可删除该类或移到单独文档/注释中说明为历史方案；若保留，需在《耐受与水池系统说明》中写明与当前实现的对应关系，避免误用。

### 2.2 命名空间不一致

- `WorldComponent_EqualMilkingAbsorptionDelay`、`PendingLactatingEntry`、`Hediff_ProlactinTolerance` 使用 **`namespace EqualMilking`**，与项目规范 **MilkCum.Milk.World / MilkCum.Milk.Comps** 不一致。
  - **建议**：统一为 `MilkCum.Milk.World` 与 `MilkCum.Milk.Comps`，便于与《Source 目录结构建议》和 rjw-cummilk-source 技能一致（改动小，仅命名空间与目录）。

### 2.3 性能与调用频率

- `ApplyDrugInducedLactationEffects` 每 30 tick 执行，内部多次 `GetFirstHediffOfDef` 与条件判断；`HediffComp_EqualMilkingLactating` 每 200 tick 做一次 L 衰减。
  - **建议**：对「当前是否药物泌乳」可做 30 tick 级缓存（如按 pawn 缓存「上一 tick 的 IsLactating + HasDrugInducedLactation」），仅变化时增删 EM_DrugLactationBurden / EM_LactatingGain，减少重复查找（优先级低，按需做）。

### 2.4 吸收延迟与存档

- `PendingLactatingEntry` 存 `Pawn` 引用；若存档时 pawn 在 caravan 或未 spawn，加载后可能需处理「pawn 为 null 或已销毁」的条目（当前已有 `e.pawn == null || !e.pawn.Spawned && e.pawn.Dead` 清理）。
  - **建议**：若支持多地图/世界地图长期运行，可考虑用 `pawnId` 或 `ThingID` 序列化，加载时再解析回 Pawn；当前简单清理已能避免崩溃（中优先级，视存档规模）。

### 2.5 文档与代码对应

- 《耐受与水池系统说明》已准确描述 t_before、Δs、进水、衰减；建议在 `ProlactinAddictionPatch` 与 `WorldComponent_EqualMilkingAbsorptionDelay` 的 summary 中注明「见 Docs/耐受与水池系统说明」「见 Docs/水池模型设计规格」，便于后续维护。

---

## 三、扩散思维：与 RimWorld / RJW 可增加的泌乳相关内容

以下为可扩展点与「有趣内容」建议，兼顾平衡与可维护性；实现难度标注为小/中/大。

### 3.1 与 RimWorld 原版联动

| 方向 | 内容 | 理由 | 难度 |
|------|------|------|------|
| **社交/关系** | 哺乳/被哺乳记忆与关系改动 | 原版有 Bond、Opinion；可增加「被某人哺乳」记忆、或「哺乳了某人」的轻微关系加成/减成（视设定：自愿 vs 强制）。 | 小 |
| **技能/工作** | 哺乳或挤奶与「医疗」或「动物」技能 | 高医疗/动物时，挤奶速度略升或「药物吸收延迟」略降（代谢率已存在，可再乘技能系数）。 | 小 |
| **特质** | 特质影响耐受或泌乳体验 | 如「嗜药」对催乳素耐受涨得更快；「身体纯净」对药物泌乳有轻微心情惩罚等（只读现有特质，不新建复杂系统）。 | 小 |
| **节日/仪式** | 哺乳或产奶相关的仪式或节日奖励 | 若存在「丰收」「家庭」类节日，可挂接：殖民地在节日内完成挤奶/哺乳给予少量心情或关系加成。 | 中 |
| **任务/事件** | 访客或囚犯请求「产奶/哺乳」相关任务 | 类似原版任务结构：交付 X 单位人奶、或让某角色被哺乳一次等，奖励银/好感。 | 中 |

### 3.2 与 RJW 联动

| 方向 | 内容 | 理由 | 难度 |
|------|------|------|------|
| **性行为后泌乳** | 某些 RJW 性行为后短时增加 L 或触发「催乳」效果 | 与现有「分娩后进水」类似，可挂接 RJW 事件，对参与者做 `AddFromDrug(小量 Δs)` 或仅给心情（如 EM_HadSexWhileLactating 已有）。 | 中 |
| **Lust / 需求** | 泌乳状态与 Lust 或性需求的联动 | 已有 rjwLustFromNursingEnabled 等；可扩展为「高满池时 Lust 略升」或「药物泌乳期性需求曲线」可配置。 | 小 |
| **身体部位/种族** | RJW 种族或身体 Def 的产奶类型/倍率 | 若 RJW 提供扩展种族或部位标签，可做「该种族默认奶类型/流速」的 Def 或补丁，避免手写列表。 | 中 |
| **剧情/对话** | 泌乳/挤奶相关的自定义对话或社交对话 | 与 Thought/Memory 配合，在社交对话中随机出现「谈论哺乳/产奶」的选项或回复，增加沉浸感。 | 小 |

### 3.3 本 mod 可独立增加的有趣内容

| 方向 | 内容 | 理由 | 难度 |
|------|------|------|------|
| **成就/里程碑** | 首次药物泌乳、首次满池溢出、长期药物泌乳等 | 用 HistoryEvent 或自定义「里程碑」记录，用于叙事或统计；不改变平衡。 | 小 |
| **药物品种扩展** | 第三种催乳药物（如「缓释」：进水少但吸收延迟更长） | 仅新增 ThingDef + outcomeDoer，水池与吸收延迟逻辑复用；需在 Docs 中补充药品 Def 变量表。 | 小 |
| **满池/溢出事件** | 满池过久触发小事件（如「胀痛」短暂心情、或请求被挤奶） | 与乳腺炎风险区分；可做成可选事件，由设置开关。 | 中 |
| **婴儿/儿童** | 儿童对「谁在哺乳我」的记忆或偏好 | 若 Biotech 有婴儿/儿童，可给「常被同一人哺乳」的婴儿加轻微心情或关系；与现有 Breastfeed 逻辑挂接。 | 中 |
| **动物差异化** | 不同动物种族对催乳药物的反应（倍率/吸收延迟） | 通过种族 Def 或设置中的「种族倍率表」调节 Δs 或延迟，丰富动物产奶策略。 | 中 |

### 3.4 平衡与可维护性注意

- 所有**新公式或参数**（如技能对吸收延迟的影响、新药 C_dose）建议在《参数联动表》或《药品 Def 变量参考》中补一行，并在代码注释中引用。
- **新 Hediff/Thought** 建议统一经 EMDefOf 引用，Keyed 键在 English 与 ChineseSimplified 同步。
- 与 RJW 的挂接保持「可选」：无 RJW 时仅跳过 RJW 相关分支，不增加必需依赖。

---

## 四、优先级汇总

| 类型 | 建议 | 优先级 |
|------|------|--------|
| 优化 | 删除或文档化 DrugEffectSystemFix 死代码 | 高 |
| 优化 | 命名空间统一（WorldComponent、PendingLactatingEntry、Hediff_ProlactinTolerance） | 中 |
| 优化 | 注释中引用 Docs（耐受与水池、水池模型规格） | 中 |
| 扩展 | 药物泌乳相关 Thought/记忆与关系、RJW Lust 扩展 | 中 |
| 扩展 | 第三种催乳药、满池小事件、动物差异化 | 低～中 |
| 扩展 | 任务/节日/仪式、RJW 性行为后泌乳挂接 | 低（按需求） |

---

*文档与《耐受与水池系统说明》《游戏已接管变量与机制清单》《水池模型设计规格》保持一致；若实现上述某项，建议同步更新对应 Docs 与参数表。*
