# 正常人吃一次药泌乳模拟

本文档模拟**正常人**（人形、无耐受、RJW 双乳对称、容量系数 2）**吃一次 Prolactin** 后的 L、双池与剩余天数。公式以《泌乳系统逻辑图》与代码为准。

---

## 1. 假设与常数

| 项 | 取值 | 说明 |
|----|------|------|
| 药物 | Prolactin | rawSeverity = 0.5（来自 Def） |
| 吃药前耐受 t_before | 0 | 第一次吃药 |
| E_tol | max(1−t, 0.05) = 1 | 无耐受 |
| 种族药物倍率 | 1 | 人类默认 |
| Δs | raw × E_tol × 种族倍率 = 0.5×1×1 = 0.5 | |
| C_dose（DoseToLFactor） | 1 | ΔL = Δs × C_dose |
| **初始 L** | **0.5** | 吃一次药后立即 L += 0.5（假设立即生效，无吸收延迟） |
| B_T | 由设置 baselineMilkDurationDays 反推 | 见下：单次剂量剩余天数 ≈ 基准天数 |
| k | 0.01 | 负反馈系数 |
| 左/右基础容量 | 各 1 | Severity 0.5 × 容量系数 2；总 maxFullness = 2 |
| 撑大上限 | 各 1.2 | 1.2×基础容量 |
| 流速倍率、饥饿、健康、基因、RJW | 均为 1 | 双池流速 = L/天（左+右各 L/2/天） |

---

## 2. 公式

- **日衰减**（每 200 tick 执行一次，200/60000 = 1/300 游戏日）：  
  D(L,E) = 1/(B_T×E) + k×L；**B_T 由 baselineMilkDurationDays 反推**：B_T_eff = 1/(0.5/baseline − k×0.5)，使单次剂量（L=0.5、E=1）时剩余天数 ≈ baseline。  
  ΔL_decay = −D(L,E) × (1/300) 每 200 tick

- **双池进水**（每 30 tick）：  
  左池流速/天 = L×1×1×1×1×1 = L，右池同；每 30 tick 总进水 = L×(30/60000)×2 = **L/1000**。  
  先填满两侧基础容量（各 1），**两侧都满后才撑大**（见《泌乳系统逻辑图》第六节）。

- **剩余天数**（显示用）：L / D(L,E)。

---

## 3. 数值模拟（摘要）

- **L 衰减**：B_T 由设置反推。**baselineMilkDurationDays = 3** 时 B_T_eff≈6.2，D≈0.16/日，L 从 0.5 降至 0 约 **≈3 日**；**baselineMilkDurationDays = 5** 时 B_T_eff≈10.5，D≈0.1/日，约 **≈5 日**。
- **双池总进水**：每 30 tick 进 L/1000，一日 2000 次 ⇒ 每日总进水 = **2L**。baseline=3 时总进池约 0.74；baseline=5 时积分更多，仍可能不满池（取决于具体 D(t)）。
- **剩余天数**：初始 L/D ≈ 基准天数（由设置决定）。

---

## 4. 简化时间线（定性）

| 游戏日 | L（约） | 左池 | 右池 | 说明 |
|--------|---------|------|------|------|
| 0 | 0.5 | 0 | 0 | 吃一次 Prolactin，L=0.5；剩余天数 ≈ 基准天数（由设置） |
| … | … | … | … | 双池在填，L 在衰减 |
| ≈baseline 日 | →0 | 清空 | 清空 | L&lt;ε，泌乳结束，双池清空 |

**结论（单次剂量）**：正常人吃一次药，剩余天数 ≈ **baselineMilkDurationDays**（**默认 5**，即约 5 日）；总进池与是否满池/撑大取决于基准天数与流速。

---

## 5. 小结

- **一次 Prolactin**：L = 0.5，剩余天数 ≈ **baselineMilkDurationDays**（设置参与衰减，**默认 5** 即约 5 日），总进池随基准天数变化。
- **满池/撑大/溢出**：是否触发取决于基准天数与流速；单次剂量、基准 3 时总进池约 0.74，通常不满池。
- 更细的逐 tick 模拟可用 `GetDailyLactationDecay`（内部用 `GetEffectiveBaseValueTForDecay()`）与 `LactationPoolState.TickGrowth` 写脚本迭代。

---

## 6. 初始 L 与「约 5 日」分析

### 初始 L 从哪里来？

- 代码路径：吃药 → `deltaS = rawSeverity × E_tol(t_before) × 种族倍率` → `AddFromDrug(deltaS)` → `currentLactationAmount += deltaS × DoseToLFactor`（DoseToLFactor=1）。
- Prolactin 的 **rawSeverity** 来自**药物 Def 的 giveHediff.severity**（由 RJW/原版 Def 定义，文档《泌乳系统逻辑图》写为 0.5）。无耐受时 E_tol=1、种族倍率=1 ⇒ **Δs = 0.5** ⇒ **初始 L = 0.5**。
- 因此：**当前实现下，吃一次 Prolactin 的初始 L 就是 0.5**（除非 Def 里改过 rawSeverity）。

### 为什么以前是约 1.5 日？现在如何得到约 5 日？

- **以前**：B_T 固定为 3（`PoolModelConstants.BaseValueT`），未与设置联动 ⇒ 剩余 ≈ 1.5 日。
- **当前实现**：**baselineMilkDurationDays 参与衰减**（`EqualMilkingSettings.GetEffectiveBaseValueTForDecay()` 反推 B_T）。**将「药物泌乳基准持续天数」设为 5**，单次 Prolactin 剩余即约 **5 日**，无需改 Def 或常量。

### 「约 5 个游戏日」可能从哪来？

1. **B_T 曾更大或设计为「基准持续」**  
   若 **B_T = 10**（而不是 3）：D = 1/10 + 0.01×0.5 = **0.105/日** ⇒ 剩余 = 0.5/0.105 ≈ **4.76 ≈ 5 日**。  
   可能以前用过大 B_T，或有人把「基准泌乳天数」理解成 B_T（设置里 baselineMilkDurationDays=3 只是 UI 参考，**未参与衰减公式**；衰减用的是常量 BaseValueT=3）。

2. **记成 Lucilactin 或多次药**  
   《耐受水池模拟结果》：**Lucilactin 一针** 初始 L=2，剩余约 **6 日**。若记混成「吃一次药约 5～6 日」，就会接近你说的 5 日。

3. **baselineMilkDurationDays = 3**  
   设置里「药物泌乳基准 3 天」是参考值，**没有参与 L 的衰减计算**。若记成 5 天，也会和 5 日对上。

### 小结

- **初始 L = 0.5** 由当前代码与 Prolactin rawSeverity=0.5 决定，没有问题。
- **剩余天数** 由设置 **baselineMilkDurationDays** 决定：该参数**参与 L 衰减**（`GetEffectiveBaseValueTForDecay()` 反推 B_T），单次剂量（L≈0.5）时剩余天数 ≈ 基准天数。**默认 5** 即约 5 日；可调更长/更短。
- 若仍希望更长/更短：调 **baselineMilkDurationDays** 即可，无需改 Def 或常量。
