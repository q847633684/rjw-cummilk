# RimWorld + RJW 体系中「已由游戏定义或已有系统接管」的变量/机制清单

本文档列出在本 mod（rjw-cummilk）所涉范围内，**不需要自己重新定义**、可直接沿用 RimWorld 原版或 RJW 已有体系的变量与机制。便于实现时「只读、只挂接、不重复造轮子」。

---

## 一、RimWorld 原版（Vanilla）

### 1.1 泌乳 / 产奶基础

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **HediffDefOf.Lactating** | 原版 Biotech 泌乳 Hediff 定义；maxSeverity、label 等由原版/扩展 Def 决定。 | 使用同一 Def，仅替换 `hediffClass` 为 `HediffWithComps_EqualMilkingLactating`，并挂 Comp。 |
| **JobDefOf.Milk** | 原版「挤奶」工作定义。 | 仅替换 `driverClass` 为 `JobDriver_EquallyMilk`，不新建 JobDef。 |
| **WorkGiverDef "Milk"** | 原版挤奶 WorkGiver。 | 仅替换 `giverClass` 为 `WorkGiver_EquallyMilk`。 |
| **CompMilkable / CompProperties_Milkable** | 原版动物产奶 Comp；谁可挤奶、产奶间隔等由种族 Def 的 comp 决定。 | 通过 Harmony 将 `compClass` 替换为 `CompEquallyMilkable`，逻辑扩展而非新建体系。 |

### 1.2 药物 / 化学系统（耐受·成瘾·需求）

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **ChemicalDef** | 原版化学物定义；`addictionHediff`、`toleranceHediff`、`onGeneratedAddictedToleranceChance` 等由游戏读取并驱动成瘾/耐受逻辑。 | 已定义 `EM_Prolactin_Chemical` 并关联 `EM_Prolactin_Tolerance`、`EM_Prolactin_Addiction`；**耐受的增减、成瘾判定、需求升降**应由原版服药与 Need 系统接管。 |
| **CompProperties_Drug**（chemical, addictiveness, minToleranceToAddict…） | 原版药品 Comp；成瘾概率、耐受门槛等由游戏按 chemical 统一处理。 | 已在 EM_Prolactin / EM_Lucilactin 的 ThingDef 中配置；**不应再在 C# 里手写成瘾概率**（见《耐受系统重构设计》方案 A）。 |
| **Need_Chemical / NeedDef（DrugAddictionNeedBase）** | 原版成瘾需求；需求条升降、戒断判定由游戏按 NeedDef + Chemical 处理。 | 已定义 `Chemical_EM_Prolactin`，继承 `Need_Chemical`；**需求数值与 fall rate 不需在 mod 内重算**。 |
| **IngestionOutcomeDoer_GiveHediff.toleranceChemical** | 原版服用时按耐受削弱本次给予的 severity。 | 已对 Lactating、EM_Prolactin_Tolerance 等 outcomeDoer 设置 `toleranceChemical>EM_Prolactin_Chemical`；**本次给药量（Δs）应由原版算出**，mod 只读结果。 |
| **HediffCompProperties_DrugEffectFactor** | 原版按化学耐受削弱药效的 Comp。 | 已在 `EM_Prolactin_Tolerance` 的 HediffDef 中挂载；**药效系数由游戏计算**，mod 只读耐受严重度。 |
| **HediffCompProperties_SeverityPerDay** | 原版 Hediff 每日严重度变化。 | 已用于 `EM_Prolactin_Tolerance`（-0.015/日）、`EM_Prolactin_Addiction`、`EM_Prolactin_High`；**耐受/成瘾的自然恢复由 XML 控制**，不在 C# 写死。 |

### 1.3 分娩 / 怀孕

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **Hediff_Pregnant / Hediff_LaborPushing** | 原版 Biotech 怀孕与分娩推进。 | 仅通过 Harmony 在 `DoBirthSpawn_Prefix` / `PreRemoved_Postfix` 中**挂接**：为母亲添加/刷新 Lactating、应用水池分娩增量；不重写分娩逻辑本身。 |

### 1.4 种族 / 体型 / 生理

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **ThingDefOf.Human / ThingDefOf.Cow**（race.baseBodySize） | 原版种族与体型基准。 | 用于默认奶量公式（人形 3×体型/人类体型，动物 14×体型/牛体型）；**不自定义体型数值**。 |
| **RaceProps.Humanlike / .Animal / .IsMechanoid** | 原版种族属性。 | 用于判定谁可挤奶、谁可哺乳、是否机械体等；**不自定义种族类别**。 |
| **PawnUtility.BodyResourceGrowthSpeed** | 原版按年龄/发育算生长速度。 | 用于泌乳期额外饥饿、产奶效率等；**不自定义生长曲线**。 |
| **PawnCapacityDefOf（Consciousness, Manipulation, Moving, Eating）** | 原版能力定义。 | 用于 Lactating 阶段 capMods、成瘾戒断阶段；**不新建 CapacityDef**。 |
| **StatDefOf.AnimalGatherYield / MechEnergyUsageFactor** | 原版采集产量、机械体能耗。 | 挤奶产量乘数、机械体泌乳能耗；**不新建 StatDef**（本 mod 自建的 EM_Milk_Amount_Factor 等是「在 Lactating 阶段上的倍率」，与上述原版 Stat 并存）。 |

### 1.5 其它原版 Def / 机制

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **FertilityFactor（Lactating 阶段）** | 原版 Lactating 的 fertilityFactor。 | 沿用阶段内 `fertilityFactor = 0.05`，不在 mod 内重算生育率。 |
| **ThoughtDef / MemoryDef（通用）** | 原版心情与记忆。 | 本 mod 自建 EM_* 的 Thought/Memory 用于剧情向（强制挤奶、伴侣食用等）；**戒断/满足等若能用原版化学心情则优先用原版**。 |
| **HistoryEventDef** | 原版历史事件。 | 若需记录服药/成瘾等，可挂接原版事件，不必要自建。 |

---

## 二、RJW 体系（若已安装）

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **RJW 怀孕/分娩事件** | RJW 若提供分娩或婴儿出生回调。 | 当前通过 patch 原版 `Hediff_Pregnant` 已覆盖 Biotech 分娩；若 RJW 有独立分娩路径，可在其回调中同样调用 `PoolModelBirthHelper.ApplyBirthPoolValues`，不重复实现分娩逻辑。 |
| **RJW 种族/身体相关** | RJW 若扩展种族或身体部位。 | 产奶/哺乳判定中已用 `RaceProps`、`IsMilkable()` 等；若 RJW 提供统一「可挤奶」接口，可优先使用。 |

---

## 三、本 mod 当前仍「自定义」且可考虑收束的项

以下为当前在代码或 Def 中**自己定义/手写**、而上述体系已能接管或部分接管的内容；重构时可按《耐受系统重构设计》与本文档收束为「只读游戏」。

| 项目 | 当前做法 | 建议 |
|------|----------|------|
| **耐受数值**（每次 +0.044 / +0.176，每日 -0.015） | 在 LactatingItems.xml 的 outcomeDoers 中 GiveHediff(EM_Prolactin_Tolerance)，且在 HediffDef 中 HediffCompProperties_SeverityPerDay -0.015。 | 若原版在服用带 chemical 的药物时**已自动**按 ChemicalDef 增加 toleranceHediff 严重度，则 outcomeDoers 中可**去掉**单独 GiveHediff(EM_Prolactin_Tolerance)，只保留 HediffCompProperties_SeverityPerDay 做自然恢复；否则保留 outcomeDoers 作为唯一可控增量。 |
| **成瘾概率**（4% × (1+耐受)） | `Milking.HandleAddictionMechanics` 中手写。 | 交给原版 ChemicalDef + CompProperties_Drug；删除或极大简化 HandleAddictionMechanics（见《耐受系统重构设计》6.1）。 |
| **有效药效系数**（max(1−耐受, 0.05)） | 多处 C# 手写。 | 统一为 `GetProlactinToleranceFactor(pawn)`，仅此一处从游戏读取耐受并换算系数。 |
| **「药物诱发泌乳」判定** | 有 EM_Prolactin_Tolerance 或 EM_Prolactin_Addiction 即视为药物诱发。 | 保持该语义即可，无需再建新 Def；仅文档化。 |
| **谁可挤奶（IsMilkable）** | 内部列表 `namesToProducts` + 设置项按种族开关。 | 人形沿用原版逻辑；动物沿用原版 CompProperties_Milkable 的「是否有 comp」+ 本 mod 设置开关，不重复定义「种族是否产奶」的底层规则。 |

---

## 四、小结

- **完全沿用、只读或只挂接的**：Lactating Def、JobDef.Milk、WorkGiver、CompMilkable 替换、ChemicalDef、Need_Chemical、toleranceChemical 对 GiveHediff 的削弱、SeverityPerDay、分娩事件、RaceProps、体型、BodyResourceGrowthSpeed、原版 Stat/PawnCapacity。
- **应交由游戏、不再手写的**：成瘾判定与概率、耐受增加（若原版已按 chemical 增加）、有效药效系数公式（收束到单一读取函数）。
- **保留自定义但收敛的**：水池 L、进水/衰减公式、产奶倍率/效率的**应用方式**（仍用自建 Stat 与阶段），以及「谁可挤奶」的设置层；仅保证其**输入**来自游戏（耐受、严重度、种族等），不重复定义这些输入本身。

与《耐受系统重构设计》配合使用时，以「耐受与成瘾完全由游戏定义与驱动，本 mod 只读并换算为水池与 UI 所需系数」为目标即可。

---

## 五、原版成瘾/需求系统所需 Def 字段清单

以下为**原版成瘾/需求系统与物品信息面板**所读取的 Def 字段；本 mod 已提供的打 ✓，可选补充的单独标出。

### 5.1 ThingDef（药品）— CompProperties_Drug

| 字段 | 用途 | 本 mod |
|------|------|--------|
| chemical | 指向 ChemicalDef，成瘾/耐受归属 | ✓ EM_Prolactin_Chemical |
| addictiveness | 每剂新成瘾几率（信息面板「新成瘾几率」） | ✓ 0.04 |
| minToleranceToAddict | 成瘾所需最低耐受（信息面板「新成瘾最小耐受」） | ✓ 0.03 |
| existingAddictionSeverityOffset | 已有成瘾时每剂+严重度（信息面板「成瘾严重度每剂」） | ✓ 0.2 |
| needLevelOffset | 每剂填满成瘾需求比例（信息面板「每剂满足需求」；与 fallPerDay 算「成瘾需求间隔」） | ✓ 1 |
| overdoseSeverityOffset / largeOverdoseChance | 过量与随机过量 | ✓ 已配置 |
| listOrder | 成瘾统计在信息面板中的排序（可选） | 未设，可补 |

### 5.2 ThingDef — statBases（信息面板「基础」）

| 字段 | 用途 | 本 mod |
|------|------|--------|
| WorkToMake | 工作量（信息面板「工作量」） | ✓ 100（EM_DrugBase / EM_Prolactin） |
| Flammability | 易燃性 | ✓ 1.0 |
| MarketValue, Mass, MaxHitPoints, DeteriorationRate | 价值、重量、耐久等 | ✓ |

### 5.3 ChemicalDef

| 字段 | 用途 | 本 mod |
|------|------|--------|
| addictionHediff | 成瘾 Hediff | ✓ EM_Prolactin_Addiction |
| toleranceHediff | 耐受 Hediff | ✓ EM_Prolactin_Tolerance |
| onGeneratedAddictedToleranceChance | 成瘾时带出耐受的概率 | ✓ 0.8 |
| generateAddictionGenes | Biotech：是否生成成瘾基因（可选，默认 true） | 未设；若不想催乳素出成瘾基因可设 false（与 RJW 驼峰菇一致） |

### 5.4 NeedDef（DrugAddictionNeedBase）

| 字段 | 用途 | 本 mod |
|------|------|--------|
| needClass | Need_Chemical | ✓ |
| chemicalNeed 的关联 | 由 addictionHediff.chemicalNeed 指向 | ✓ Chemical_EM_Prolactin |
| label, description, listPriority | 需求名称与列表顺序 | ✓ |
| fallPerDay | 成瘾需求条每日下降（信息面板「成瘾需求降低速率」「成瘾需求间隔」） | ✓ 0.5 |
| developmentalStageFilter | 仅成人等（可选） | 未设 |

### 5.5 HediffDef — 成瘾（EM_Prolactin_Addiction）

| 字段 | 用途 | 本 mod |
|------|------|--------|
| hediffClass | Hediff_Addiction | ✓ |
| chemicalNeed | 指向 NeedDef | ✓ Chemical_EM_Prolactin |
| initialSeverity | 新成瘾初始严重度（信息面板「成瘾初始严重度」） | ✓ 0.5 |
| comps: SeverityPerDay | 成瘾严重度每日恢复 | ✓ -0.015 |
| showDaysToRecover | 信息面板/健康页显示「成瘾恢复时间」 | ✓ true |
| stages | 满足 / 戒断 两阶段 | ✓ |

### 5.6 HediffDef — 耐受（EM_Prolactin_Tolerance）

| 字段 | 用途 | 本 mod |
|------|------|--------|
| SeverityPerDay | 耐受每日自然下降（信息面板「抗药性降低速率」） | ✓ -0.015 |
| HediffCompProperties_DrugEffectFactor.chemical | 参与原版药效系数 | ✓ EM_Prolactin_Chemical |

---

**小结**：必填项均已提供；可选补充仅两项：  
1）ChemicalDef 增加 `<generateAddictionGenes>false</generateAddictionGenes>`（与 RJW 一致，避免 Biotech 成瘾基因）；  
2）CompProperties_Drug 增加 `<listOrder>30</listOrder>`（仅影响信息面板成瘾区块排序）。

---

## 六、信息面板统计与「药物浓度」「能力影响」说明

### 6.1 游戏内成瘾品区块与数据来源

| 游戏显示项 | 数据来源（原版） | 本 mod 情况 |
|------------|------------------|-------------|
| 娱乐 | ingestible.joy + joyKind，或 IngestionOutcomeDoer_OffsetNeed(Joy) | ✓ 有 OffsetNeed(Joy, 0.3)，会显示娱乐 |
| 化学物质 | CompProperties_Drug.chemical → ChemicalDef.label | ✓ EM_Prolactin_Chemical |
| 成瘾品分类 | ingestible.drugCategory | ✓ Medical（EM_DrugBase） |
| **药物浓度** | **药品「主效果」Hediff 的 severity**（通常为第一个 GiveHediff 给的、带严重度的 Hediff） | 主效果为 Lactating，severity=0.5 → 会显示 50%；见下 6.2 |
| **浓度降低速率** | 主效果 Hediff 的 **HediffCompProperties_SeverityPerDay** | Lactating 无该 Comp（我们用池 L 衰减），**面板可能为空或 0** |
| **有效浓度时间** | 由 药物浓度 ÷ 浓度降低速率 推算的持续时间 | 因无 SeverityPerDay，**可能不显示或异常** |
| 每剂抗药性 | 耐受 Hediff 的 GiveHediff.severity（每剂增加量） | ✓ 0.044（XML） |
| 抗药性降低速率 | 耐受 Hediff 的 SeverityPerDay | ✓ -0.015/日 |
| 成年人安全服用间隔、随机过量几率 | CompProperties_Drug + 原版计算 | ✓ 已配置 |
| 精神力/性需求 | RJW 的 Need（Sex 等）或 IngestionOutcomeDoer_OffsetNeed | 性需求为 RJW；本 mod 只有 Joy |
| 成瘾品成瘾（抗药性阈值、成瘾性、每剂成瘾度等） | 见第五节 | ✓ 已提供 |

### 6.2 药物浓度的作用

- **原版含义**：「药物浓度」= 体内当前**主效果 Hediff 的严重度**，表示药效还有多强；**浓度降低速率** = 该 Hediff 每天掉多少严重度；**有效浓度时间** = 浓度 ÷ 降低速率，即大约还能持续多久。
- **本 mod**：主效果是 **Lactating**，但泌乳的「还有多少、持续多久」由 **池 L** 和 200 tick 衰减在 C# 里算，**不是**用 Lactating 的 SeverityPerDay。因此：
  - 面板上的「药物浓度」会显示（Lactating 的 severity，如 0.5）；
  - 「浓度降低速率」「有效浓度时间」**没有**对应 Def（Lactating 无 SeverityPerDay），所以**不会和池模型一致**，属设计取舍：**真实持续时间看池模型与剩余天数**，不在成瘾品区块里重复。

### 6.3 能力影响：游戏 vs 本 mod

| 来源 | 含义 | 本 mod 情况 |
|------|------|-------------|
| **游戏「能力影响」** | 信息面板从**该药品 outcomeDoers 给的 Hediff** 的 **stages.capMods** 里读，并列出能力修正。 | 催乳剂给的 Hediff：Lactating、EM_Prolactin_Tolerance、Joy。Lactating 的 stage 在 C# 里 **GenStage() 动态生成且 capMods 被 Clear**，故**药品信息里不会列出能力影响**。 |
| **本 mod 能力影响** | (1) **EM_LactatingGain**：单独 Hediff，C# 里按设置与 Lactating severity **动态写** stage.capMods（意识/操纵/移动 +offset），由 CompEquallyMilkable 在满足条件时添加。(2) **成瘾戒断/负担**：EM_Prolactin_Addiction 戒断阶段、EM_DrugLactationBurden、EM_BreastsEngorged 等在 HediffDef 的 stages 里写死 capMods。 | (1) 只影响**健康页**与实际能力，**不**来自药品 outcomeDoers，故**不会**出现在药品信息「能力影响」里。(2) 成瘾/戒断/负担的能力是**戒断或满池**时的负面，不是「主药效果」能力。 |

**结论**：  
- **没有重复逻辑**。游戏只根据 Hediff 的 stage.capMods 统一算能力；本 mod 要么通过 **EM_LactatingGain** 动态填 capMods（增益），要么用 Def 里戒断/负担的 capMods（负面），**同一条能力只由一处提供**。  
- **区别**：游戏「能力影响」= 药品**主效果 Hediff** 的静态 capMods；本 mod 的增益放在**独立 Hediff EM_LactatingGain** 且用 C# 按设置和严重度算 offset，所以**不会**在药品信息里显示，只在健康页和实际能力上生效。

### 6.4 若成瘾/化学物质/每剂抗药性等仍不显示

- **已做修改**：`EM_DrugBase` 改为继承 **MakeableDrugBase**（与 RJW 壮阳药一致），以便原版按「可制作药品」路径绘制完整成瘾区块；EM_Prolactin 已补 **ingestible.joy / joyKind**（娱乐）、**Comp listOrder**；ChemicalDef 已补 **generateAddictionGenes false**。
- **若仍不显示**：请确认 (1) 存档或新档中查看的是 **EM_Prolactin** 物品信息；(2) 信息窗口是否需**展开**「成瘾品」「成瘾品成瘾」等折叠区块；(3) 仅开 rjw-cummilk + 依赖 mod 测试，排除其它 mod 覆盖 ThingDef/Comp。
- **精神力/性需求**：**性需求**（RJW Need_Sex）由 RJW 药品的 IngestionOutcomeDoer_OffsetNeed(Need=Sex) 提供；本 mod 催乳剂只做了 **Joy**（娱乐），不做 Sex。若要在面板显示性需求，需在 outcomeDoers 中增加对 RJW 的 Need「Sex」的 OffsetNeed（并依赖 RJW 已加载），当前未加以保持与无 RJW 时行为一致。
