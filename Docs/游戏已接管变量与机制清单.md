# RimWorld + RJW 体系中「已由游戏定义或已有系统接管」的变量/机制清单

本文档列出在本 mod（rjw-cummilk）所涉范围内，**不需要自己重新定义**、可直接沿用 RimWorld 原版或 RJW 已有体系的变量与机制。便于实现时「只读、只挂接、不重复造轮子」。

---

## 一、RimWorld 原版（Vanilla）

### 1.1 泌乳 / 产奶基础

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **HediffDefOf.Lactating** | 原版 Biotech 泌乳 Hediff 定义；maxSeverity、label 等由原版/扩展 Def 决定。 | 使用同一 Def，仅替换 `hediffClass` 为 `HediffWithComps_EqualMilkingLactating`，并挂 Comp。 |
| **JobDefOf.Milk** | 原版「挤奶」工作定义。 | 仅替换 `driverClass` 为 `JobDriver_EquallyMilk`，不新建 JobDef。 |
| **WorkGiverDef "Milk"** | 原版挤奶 WorkGiver。 | 仅替换 `giverClass` 为 `WorkGiver_EquallyMilk`。 |
| **CompMilkable / CompProperties_Milkable** | 原版动物产奶 Comp；谁可挤奶、产奶间隔等由种族 Def 的 comp 决定。 | 通过 Harmony 将 `compClass` 替换为 `CompEquallyMilkable`，逻辑扩展而非新建体系。 |

### 1.2 药物 / 化学系统（耐受·成瘾·需求）

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **ChemicalDef** | 原版化学物定义；`addictionHediff`、`toleranceHediff`、`onGeneratedAddictedToleranceChance` 等由游戏读取并驱动成瘾/耐受逻辑。 | 已定义 `EM_Prolactin_Chemical` 并关联 `EM_Prolactin_Tolerance`、`EM_Prolactin_Addiction`；**耐受的增减、成瘾判定、需求升降**应由原版服药与 Need 系统接管。 |
| **CompProperties_Drug**（chemical, addictiveness, minToleranceToAddict…） | 原版药品 Comp；成瘾概率、耐受门槛等由游戏按 chemical 统一处理。 | 已在 EM_Prolactin / EM_Lucilactin 的 ThingDef 中配置；**不应再在 C# 里手写成瘾概率**（见《耐受系统重构设计》方案 A）。 |
| **Need_Chemical / NeedDef（DrugAddictionNeedBase）** | 原版成瘾需求；需求条升降、戒断判定由游戏按 NeedDef + Chemical 处理。 | 已定义 `Chemical_EM_Prolactin`，继承 `Need_Chemical`；**需求数值与 fall rate 不需在 mod 内重算**。 |
| **IngestionOutcomeDoer_GiveHediff.toleranceChemical** | 原版服用时按耐受削弱本次给予的 severity。 | 已对 Lactating、EM_Prolactin_Tolerance 等 outcomeDoer 设置 `toleranceChemical>EM_Prolactin_Chemical`；**本次给药量（Δs）应由原版算出**，mod 只读结果。 |
| **HediffCompProperties_DrugEffectFactor** | 原版按化学耐受削弱药效的 Comp。 | 已在 `EM_Prolactin_Tolerance` 的 HediffDef 中挂载；**药效系数由游戏计算**，mod 只读耐受严重度。 |
| **HediffCompProperties_SeverityPerDay** | 原版 Hediff 每日严重度变化。 | 已用于 `EM_Prolactin_Tolerance`（-0.015/日）、`EM_Prolactin_Addiction`、`EM_Prolactin_High`；**耐受/成瘾的自然恢复由 XML 控制**，不在 C# 写死。 |

### 1.3 分娩 / 怀孕

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **Hediff_Pregnant / Hediff_LaborPushing** | 原版 Biotech 怀孕与分娩推进。 | 仅通过 Harmony 在 `DoBirthSpawn_Prefix` / `PreRemoved_Postfix` 中**挂接**：为母亲添加/刷新 Lactating、应用水池分娩增量；不重写分娩逻辑本身。 |

### 1.4 种族 / 体型 / 生理

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **ThingDefOf.Human / ThingDefOf.Cow**（race.baseBodySize） | 原版种族与体型基准。 | 用于默认奶量公式（人形 3×体型/人类体型，动物 14×体型/牛体型）；**不自定义体型数值**。 |
| **RaceProps.Humanlike / .Animal / .IsMechanoid** | 原版种族属性。 | 用于判定谁可挤奶、谁可哺乳、是否机械体等；**不自定义种族类别**。 |
| **PawnUtility.BodyResourceGrowthSpeed** | 原版按年龄/发育算生长速度。 | 用于泌乳期额外饥饿、产奶效率等；**不自定义生长曲线**。 |
| **PawnCapacityDefOf（Consciousness, Manipulation, Moving, Eating）** | 原版能力定义。 | 用于 Lactating 阶段 capMods、成瘾戒断阶段；**不新建 CapacityDef**。 |
| **StatDefOf.AnimalGatherYield / MechEnergyUsageFactor** | 原版采集产量、机械体能耗。 | 挤奶产量乘数、机械体泌乳能耗；**不新建 StatDef**（本 mod 自建的 EM_Milk_Amount_Factor 等是「在 Lactating 阶段上的倍率」，与上述原版 Stat 并存）。 |

### 1.5 其它原版 Def / 机制

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **FertilityFactor（Lactating 阶段）** | 原版 Lactating 的 fertilityFactor。 | 沿用阶段内 `fertilityFactor = 0.05`，不在 mod 内重算生育率。 |
| **ThoughtDef / MemoryDef（通用）** | 原版心情与记忆。 | 本 mod 自建 EM_* 的 Thought/Memory 用于剧情向（强制挤奶、伴侣食用等）；**戒断/满足等若能用原版化学心情则优先用原版**。 |
| **HistoryEventDef** | 原版历史事件。 | 若需记录服药/成瘾等，可挂接原版事件，不必要自建。 |

---

## 二、RJW 体系（若已安装）

| 项目 | 说明 | 本 mod 用法 |
|------|------|-------------|
| **RJW 怀孕/分娩事件** | RJW 若提供分娩或婴儿出生回调。 | 当前通过 patch 原版 `Hediff_Pregnant` 已覆盖 Biotech 分娩；若 RJW 有独立分娩路径，可在其回调中同样调用 `PoolModelBirthHelper.ApplyBirthPoolValues`，不重复实现分娩逻辑。 |
| **RJW 种族/身体相关** | RJW 若扩展种族或身体部位。 | 产奶/哺乳判定中已用 `RaceProps`、`IsMilkable()` 等；若 RJW 提供统一「可挤奶」接口，可优先使用。 |

---

## 三、本 mod 当前仍「自定义」且可考虑收束的项

以下为当前在代码或 Def 中**自己定义/手写**、而上述体系已能接管或部分接管的内容；重构时可按《耐受系统重构设计》与本文档收束为「只读游戏」。

| 项目 | 当前做法 | 建议 |
|------|----------|------|
| **耐受数值**（每次 +0.044 / +0.176，每日 -0.015） | 在 LactatingItems.xml 的 outcomeDoers 中 GiveHediff(EM_Prolactin_Tolerance)，且在 HediffDef 中 HediffCompProperties_SeverityPerDay -0.015。 | 若原版在服用带 chemical 的药物时**已自动**按 ChemicalDef 增加 toleranceHediff 严重度，则 outcomeDoers 中可**去掉**单独 GiveHediff(EM_Prolactin_Tolerance)，只保留 HediffCompProperties_SeverityPerDay 做自然恢复；否则保留 outcomeDoers 作为唯一可控增量。 |
| **成瘾概率**（4% × (1+耐受)） | `Milking.HandleAddictionMechanics` 中手写。 | 交给原版 ChemicalDef + CompProperties_Drug；删除或极大简化 HandleAddictionMechanics（见《耐受系统重构设计》6.1）。 |
| **有效药效系数**（max(1−耐受, 0.05)） | 多处 C# 手写。 | 统一为 `GetProlactinToleranceFactor(pawn)`，仅此一处从游戏读取耐受并换算系数。 |
| **「药物诱发泌乳」判定** | 有 EM_Prolactin_Tolerance 或 EM_Prolactin_Addiction 即视为药物诱发。 | 保持该语义即可，无需再建新 Def；仅文档化。 |
| **谁可挤奶（IsMilkable）** | 内部列表 `namesToProducts` + 设置项按种族开关。 | 人形沿用原版逻辑；动物沿用原版 CompProperties_Milkable 的「是否有 comp」+ 本 mod 设置开关，不重复定义「种族是否产奶」的底层规则。 |

---

## 四、小结

- **完全沿用、只读或只挂接的**：Lactating Def、JobDef.Milk、WorkGiver、CompMilkable 替换、ChemicalDef、Need_Chemical、toleranceChemical 对 GiveHediff 的削弱、SeverityPerDay、分娩事件、RaceProps、体型、BodyResourceGrowthSpeed、原版 Stat/PawnCapacity。
- **应交由游戏、不再手写的**：成瘾判定与概率、耐受增加（若原版已按 chemical 增加）、有效药效系数公式（收束到单一读取函数）。
- **保留自定义但收敛的**：水池 L、进水/衰减公式、产奶倍率/效率的**应用方式**（仍用自建 Stat 与阶段），以及「谁可挤奶」的设置层；仅保证其**输入**来自游戏（耐受、严重度、种族等），不重复定义这些输入本身。

与《耐受系统重构设计》配合使用时，以「耐受与成瘾完全由游戏定义与驱动，本 mod 只读并换算为水池与 UI 所需系数」为目标即可。
