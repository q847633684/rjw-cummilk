# 耐受与水池系统说明（当前实现）

本文档按**当前代码与 Def** 描述催乳素耐受、泌乳水池 L、双池（左乳/右乳）及 UI 的完整行为，供查阅与维护使用。

---

## 一、概述

- **耐受**：完全沿用 RimWorld 原版化学耐受。催乳素耐受 Hediff 为 `EM_Prolactin_Tolerance`，严重度 \(t \in [0, 1]\)，由 XML 与原生机制控制“每次吃药增加”和“每日自然衰减”；代码只**读取** \(t\)，不手写具体数值。
- **水池 L**：表示“当前泌乳量”的抽象池，归一化下 **L = 1** 约等于“满一池”的等效容量。L 由**吃药进水**和**每日衰减**驱动；L 降至 0 时泌乳结束并移除 Lactating。
- **双池**：可挤奶/吸奶的奶量由**左乳**与**右乳**两个池子表示，总满度 `Fullness = 左乳 + 右乳`（单侧满为 0.5，双侧满为 1）。L 通过进水流速填充双池，挤奶时从一侧排空。
- **统一耐受系数** \(E_\text{tol}(t)\)：所有“被耐受削弱”的效果（进水时的有效剂量、产奶倍率、效率倍率等）统一用同一公式，不重复写多种衰减。

---

## 二、耐受

### 2.1 数据来源

- **Hediff**：`EM_Prolactin_Tolerance`（`HediffDefs.xml`），`ChemicalDef` 中作为 `EM_Prolactin_Chemical` 的 `toleranceHediff`。
- **每次服用 Prolactin**：XML 中 `IngestionOutcomeDoer_GiveHediff` 为耐受 +0.044（`divideByBodySize>true`，人类体型 1 即 +0.044）。
- **每次服用 Lucilactin**：耐受 +0.176（0.044×4）。
- **每日自然衰减**：`HediffCompProperties_SeverityPerDay` 的 `severityPerDay = -0.015`。

代码中仅通过 `EqualMilkingSettings.GetProlactinTolerance(pawn)` 读取当前 \(t\)，不在 C# 里写 0.044 / 0.176 / 0.015 等数值。

### 2.2 统一耐受系数 \(E_\text{tol}(t)\)

- **公式**：\(E_\text{tol}(t) = \max(1 - t,\ E_{\min})\)，\(E_{\min} = 0.05\)（`PoolModelConstants.EffectiveDrugFactorMin`）。
- **含义**：\(t=0\) 时满效果；\(t\) 越大药效越弱；\(t=1\) 时仍保留至少 5% 效果。
- **代码**：`EqualMilkingSettings.GetProlactinToleranceFactor(Pawn)` 或 `GetProlactinToleranceFactor(float toleranceSeverity)`（按数值 t 计算，用于进水时传入吃药前 \(t_\text{before}\)）。

---

## 三、水池 L

### 3.1 含义与驱动

- **L**（`currentLactationAmount`）：当前泌乳量，无硬上限；L > 0 时存在泌乳状态，L 每 200 tick 按日衰减扣减，低于阈值（\(L < \varepsilon\)）时视为 0 并结束泌乳（移除 Lactating、清空双池）。
- **进水**：仅来自“吃药”与“分娩”。吃药进水见下节；分娩时 `AddFromBirth()` 使 L 增加一档基础值（不乘耐受系数）。

### 3.2 吃药时的进水（当前实现）

- **设计要点**：耐受只作用一次。先算出“本次实际生效的 Lactating 严重度增量”\(\Delta s\)，再按 \(\Delta L = \Delta s \times C_\text{dose}\) 进水，**不再**对 \(\Delta s\) 乘第二次 \(E_\text{tol}\)，避免耐受被平方。
- **实现**：
  - 吃药前耐受记为 \(t_\text{before}\)（本剂在 XML 中在 Lactating 之后添加耐受，故 postfix 里当前耐受已含本剂，\(t_\text{before} = \max(0,\ \text{当前耐受} - 0.044)\) 或 Lucilactin 对应增量）。
  - **有效严重度**：\(\Delta s = \text{rawSeverity} \times E_\text{tol}(t_\text{before})\)。rawSeverity 即 XML 中该药的 Lactating 严重度（Prolactin 0.5，Lucilactin 2.0）。
  - **进水**：\(\Delta L = \Delta s \times C_\text{dose}\)，\(C_\text{dose} = 1\)（`PoolModelConstants.DoseToLFactor`）。即 `AddFromDrug(deltaSeverity)` 内只做 `currentLactationAmount += deltaSeverity * DoseToLFactor`。
- **流程**：服用给 Lactating 的药物后，Harmony postfix 移除刚加的 Lactating，计算 \(t_\text{before}\) 与 rawSeverity，若有 World 则写入 `WorldComponent_EqualMilkingAbsorptionDelay` 的待生效队列（含 rawSeverity、endTick、toleranceBefore）；到点时计算 \(\Delta s = \text{rawSeverity} \times E_\text{tol}(\text{toleranceBefore})\)，重新挂上 Lactating 并调用 `AddFromDrug(Δs)`。

### 3.3 每日衰减

- **公式**：每日衰减率  
  \[
  D(L,\,t) = \frac{1}{B_T \times E_\text{tol}(t)} + k \times L
  \]
  其中 \(B_T = 3\)（`BaseValueT`），\(k = 0.01\)（`NegativeFeedbackK`），\(E_\text{tol}(t)\) 由当前 Pawn 耐受得到（且 \(E_\text{tol} \geq 0.05\)，不会除零）。
- **含义**：耐受越高 \(E_\text{tol}\) 越小，基础衰减项越大，泌乳持续越短；L 越大，\(kL\) 项越大，形成负反馈。
- **实现**：每 200 tick 执行一次，步长 `step = 200/60000` 天，`currentLactationAmount -= GetDailyLactationDecay(currentLactationAmount) * step`；若 L 低于 `LactationEndEpsilon` 则置 0 并调用泌乳结束逻辑（清空双池、移除 Lactating）。

---

## 四、双池（左乳 / 右乳）

- **结构**：`CompEquallyMilkable` 内维护 `leftFullness`、`rightFullness`，单侧范围 0～0.5（基础半池），满池撑大时单侧上限为 `HalfPool × StretchCapFactor`。
- **总满度**：`Fullness = leftFullness + rightFullness`，对外表示“可挤奶/吸奶总量”，0～1 对应空～满。
- **进水**：L 每 30 tick 按“当前泌乳量 L × 饥饿系数”产生进水流速，**两侧各分一半**填入左/右池；若某侧已满则产生溢出（累计达阈值时生成地面污物），超出基础容量的部分会随时间缓慢回缩。
- **挤奶/吸奶**：先选较满一侧（相同时按性别“男左女右”），排空该侧并产出奶，不跨侧混合。
- **泌乳结束**：L 归零时 `ClearPools()` 将左、右池均置 0。

---

## 五、常数与 Def 数值汇总

| 符号/名称 | 值 | 说明 |
|-----------|-----|------|
| \(B_T\) | 3 | 基础值_T，日衰减分母 |
| \(k\) | 0.01 | 负反馈系数 |
| \(E_{\min}\) | 0.05 | 耐受系数下限 |
| \(C_\text{dose}\) | 1 | 剂量转 L 系数 |
| Prolactin 耐受/次 | 0.044 | XML，人类体型 |
| Lucilactin 耐受/次 | 0.176 | XML |
| 耐受日衰减 | -0.015 | XML severityPerDay |
| Prolactin rawSeverity | 0.5 | XML |
| Lucilactin rawSeverity | 2.0 | XML |
| 吸收延迟基准 tick | 15000 | 约 0.25 游戏日，再按代谢率缩放 |

---

## 六、UI 显示

- **健康面板泌乳 Hediff 括号内**：显示“奶量: xx%”“(左乳 xx%, 右乳 xx%)”、剩余天数、当前泌乳量 L、产奶量等。左乳/右乳为单侧满度百分比（各侧 50% 即单侧满）。
- **翻译键**：`EM.PoolLeftBreast`（左乳）、`EM.PoolRightBreast`（右乳）、`EM.PoolRemainingDays`（剩余天数）、`EM.PoolCurrentLactation`（当前泌乳量）等见 `Languages/*/Keyed/lang.xml`。

---

## 七、数值参考（当前公式）

- **只打一针 Prolactin**：\(\Delta s = 0.5 \times 1 = 0.5\)，L 增加 0.5；约 **2 天**内 L 衰减至 0，泌乳结束；L 最大 0.5，达不到“满一池”（L≥1）。
- **只打一针 Lucilactin**：\(\Delta s = 2.0 \times 1 = 2.0\)，L 增加 2.0；约 **6 天**内 L 衰减至 0；起始即超过满池等效。
- **多日多次用药**：耐受会累积（每日仅 -0.015），后续每针的 \(\Delta s\) 会随 \(t_\text{before}\) 增大而变小，L 的日衰减也会因 \(E_\text{tol}\) 变小而加快；详见 `Docs/耐受水池模拟结果.md` 与脚本 `Docs/tolerance_pool_simulate.py`。

---

## 八、相关文件

- 耐受/水池逻辑：`Source/EqualMilking/Comps/HediffWithComps_EqualMilkingLactating.cs`、`EqualMilkingSettings.cs`、`Helpers/Constants.cs`
- 双池与挤奶：`Source/EqualMilking/Comps/CompEquallyMilkable.cs`
- 吃药与进水入口：`Source/EqualMilking/HarmonyPatches/Milking.cs`、`WorldComponent_EqualMilkingAbsorptionDelay.cs`
- Def：`Defs/HediffDefs.xml`、`Defs/ChemicalDefs.xml`、`Defs/LactatingItems.xml`
- 设计与模拟：`Docs/耐受系统重构设计.md`、`Docs/耐受水池模拟结果.md`、`Docs/tolerance_pool_simulate.py`
