## 一、目标与原则

- **统一“耐受”的含义**：完全沿用 RimWorld 原版的化学耐受概念（`ChemicalDef.toleranceHediff`），把 `EM_Prolactin_Tolerance` 视为一颗**普通的耐受 Hediff**，其数值变化（吃药增加、时间衰减）全部交给游戏原生机制与 XML Comp 控制。
- **水池与耐受解耦**：水池系统不再自己“存耐受”“算耐受”，只**被动读取**当前耐受严重度，并通过一套统一函数 `E_tolerance(t)` 影响进水与消耗。
- **少公式、多复用**：所有“被耐受削弱”的效果（进水、产奶倍率、效率倍率、额外饥饿/能耗）统一用同一个耐受系数，而不是到处写不同的 `1 - t` 或自定义衰减。

> 约定：当前游戏中的催乳素耐受 Hediff 仍使用 `defName = EM_Prolactin_Tolerance`，严重度记为 \(t \in [0, 1]\)。

---

## 二、耐受数据来源（完全使用游戏内定义）

- **来源**：  
  - `EM_Prolactin_Tolerance` 作为某个化学（例如 `ChemicalDef EM_Prolactin`) 的 `toleranceHediff`。  
  - 每次服用 Prolactin / Lucilactin 时，由 `IngestionOutcomeDoer_GiveHediff` 与 vanilla `toleranceChemical` 逻辑负责：  
    - 增加 `EM_Prolactin_Tolerance` 的严重度  
    - 决定本次 `Lactating` 严重度的有效增量（高耐受时增量变小）  
  - 每日耐受自然恢复、Stage 说明、图标等都由 XML Comp 与 vanilla 逻辑控制。

- **代码层面唯一的读取接口**（保留函数名，语义对齐 vanilla）：

```12:20:Source/EqualMilking/EqualMilkingSettings.cs
	/// <summary>当前催乳素耐受严重度 t ∈ [0,1]；完全由游戏内 Hediff/Comp 决定。</summary>
	internal static float GetProlactinTolerance(Pawn pawn)
```

> 本设计要求：**不在 C# 代码里手写“耐受每日 -0.015”“每次吃药 +0.044/+0.176”等具体数值**，这些数值全部留在 XML 中交给 vanilla 机制。

---

## 三、统一耐受系数函数 \(E_\text{tol}(t)\)

- **输入**：当前耐受严重度 \( t = \text{GetProlactinTolerance(pawn)} \in [0, 1]\)
- **输出**：耐受对“药效相关加成”的统一系数 \( E_\text{tol}(t) \)

建议公式：

\[
E_\text{tol}(t) = \max(1 - t,\ E_{\min})
\]

- 默认下限：\(E_{\min} = 0.05\)（可在设置中改动，范围 \([0, 0.5]\)）
- 语义：
  - \(t = 0\)：完全无耐受 → \(E_\text{tol} = 1\)，满效果
  - \(t = 0.5\)：中度耐受 → 只剩 50% 药效
  - \(t = 1\)：高度耐受 → 至少保留 \(E_{\min}\) 的效果（不至于完全白吃药）

在代码中提供一个集中函数（示意）：

```21:32:Source/EqualMilking/EqualMilkingSettings.cs
	internal static float GetProlactinToleranceFactor(Pawn pawn)
	{
		float t = GetProlactinTolerance(pawn);               // 0..1
		float min = EqualMilkingSettings.prolactinTolMin;   // 缓存的设置值，默认 0.05
		return Mathf.Max(1f - t, min);
	}
```

> 所有“被耐受削弱”的玩法效果**一律只读这个函数**，不直接在其它地方写 `1 - t` 或重复的 `max(1-t,0.05)`。

---

## 四、水池 L 与耐受的关系（重构版）

### 4.1 状态量与符号

- **L**：当前泌乳量（水池总量，归一化容量 1 为“正常满池一次”）
- **B**：基础值 = 总容量的归一化基准（仍约定为 1）
- **B_T**：基础值_T（控制“天然存在时间”，仍采用 3 游戏日）
- **k**：负反馈系数，默认 `0.01`
- **E_tol**：耐受系数 = `GetProlactinToleranceFactor(pawn)`

### 4.2 吃药时的进水

- **当前实现问题**：`AddFromDrug(float rawSeverity)` 直接做 `L += BaseValue × E`，完全不看本次真实 `severity`，且把“耐受影响”又手算了一遍，与 vanilla 对 `Lactating` 的严重度控制脱节。

- **重构设计**：
  - **输入**：本次实际生效的 `Lactating` 严重度增量 \(\Delta s\)  
  - **进水公式**：

    \[
    \Delta L = \Delta s \times C_\text{dose} \times E_\text{tol}(t_\text{before})
    \]

    - \(\Delta s\)：由 `IngestionOutcomeDoer_GiveHediff` + vanilla `toleranceChemical` 算好，我们只读结果  
    - \(C_\text{dose}\)：剂量转 L 的系数（设置项，默认 1）  
    - \(E_\text{tol}\)：用**吃药前**的耐受算（避免同一剂量内“先加耐受再减药效”的重复运算）

  - 在代码中：
    - 在应用 `Lactating` 严重度后，计算本次实际增量 `deltaSeverity = newSeverity - oldSeverity`，传给 `AddFromDrug(deltaSeverity)`。
    - `AddFromDrug` 内部只做简单线性换算：`currentLactationAmount += deltaSeverity * doseToLFactor * GetProlactinToleranceFactor(Pawn);`

### 4.3 每日衰减（存在时间）

延续水池模型思路，但让“耐受”只参与**第一项“基础衰减”**：

\[
D(L, t) = \frac{1}{B_T \times E_\text{tol}(t)} + k \times L
\]

- 意义：
  - **耐受越高 ⇒ 有效药效越弱 ⇒ 泌乳持续时间越短**  
    - \(E_\text{tol}\) 变小 → \(1/(B_T \times E_\text{tol})\) 变大 → 单位 L 每日消耗更快
  - \(k \times L\) 仍是原有的“水池越满越快降”的负反馈，不再额外叠加其它自定义系数。

在实现上：

```195:201:Source/EqualMilking/Comps/HediffWithComps_EqualMilkingLactating.cs
    public float GetDailyLactationDecay(float lactationAmount)
    {
        float eff = EqualMilkingSettings.GetProlactinToleranceFactor(Pawn);
        if (eff <= 0f) return 0f;
        return 1f / (PoolModelConstants.BaseValueT * eff)
             + PoolModelConstants.NegativeFeedbackK * lactationAmount;
    }
```

> 注意：**不再在任何地方手写“0.1×(1+耐受)”之类旧公式**，保证只通过 `GetProlactinToleranceFactor` 间接反映耐受。

---

## 五、与产奶倍率/效率/饥饿等的统一规则

当前代码中，以下位置直接/间接使用了“自定义耐受公式”，需要在实现时统一改为通过 `GetProlactinToleranceFactor`：

- `EqualMilkingSettings.GetMilkAmountFactorWithTolerance`
- `EqualMilkingSettings.GetLactatingEfficiencyFactorWithTolerance`
- `HediffComp_EqualMilkingLactating.ExtraNutritionPerDay`
- `HediffComp_EqualMilkingLactating.ExtraEnergyPerDay`
- `ExtensionHelper.MilkGrowthTime`

### 5.1 统一思路

1. 先从各自基础来源算出“未考虑耐受的倍率”：
   - 产奶倍率：`baseAmountFactor = pawn.GetStatValue(EM_Milk_Amount_Factor);`
   - 效率倍率：`baseEffFactor = pawn.GetStatValue(EM_Lactating_Efficiency_Factor);`
   - 额外饥饿/能耗：由当前 Hediff Stage 决定的 `hungerRateFactorOffset` / `MechEnergyUsageFactor` offset。
2. 再应用统一耐受系数，仅作用在“>1 的增益部分”：

\[
f_\text{withTol} = 1 + (f_\text{base} - 1) \times E_\text{tol}(t)
\]

在代码中可复用一个工具函数，例如：

```485:497:Source/EqualMilking/EqualMilkingSettings.cs
	internal static float ApplyToleranceToBoost(float baseFactor, float t)
	{
		if (baseFactor <= 1f) return baseFactor;
		float e = GetProlactinToleranceFactor(t);
		return 1f + (baseFactor - 1f) * e;
	}
```

随后：

- `GetMilkAmountFactorWithTolerance` / `GetLactatingEfficiencyFactorWithTolerance` 调用该函数。
- `ExtraNutritionPerDay` / `ExtraEnergyPerDay` 不再自行 `* (1 - tol)`，而是通过前面的“含耐受倍率”自然反映减弱。

---

## 六、成瘾与其它系统

### 6.1 成瘾概率

当前 `Milking.HandleAddictionMechanics` 中：

- 基础成瘾概率固定 4%
- 若已有耐受：`addictionChance *= (1 + tolerance.Severity)`

这与 vanilla 思路略相反（vanilla 通常是“高耐受多半已是老药鬼”，但实际成瘾逻辑更复杂）。为避免过度自创一套规则，本设计建议：

- **方案 A（推荐，简单）**：  
  - 成瘾完全交给 vanilla 的 `ChemicalDef.addictionHediff` + `needChemical` + 服药记录逻辑处理，`Milking` 不再手写成瘾概率。
- **方案 B（保留轻度自定义）**：  
  - 把当前逻辑改为仅在“无成瘾但多次服药且耐受≥阈值”时**额外补一次判定**：  
    - 例如 \(t \ge 0.5\) 且最近 5 天内服用 ≥ N 次时，额外触发 1~2% 的补充成瘾判定。

> 实现时只需要在 MD 里明确“本模组是否主动控制成瘾”，避免未来出现双重成瘾逻辑。

### 6.2 “仅药物诱发泌乳才加能力值”的判定

当前判定条件：“有 `EM_Prolactin_Tolerance` 或 `EM_Prolactin_Addiction`”即视为药物诱发。  
本设计沿用该语义，仅整理到规格中：

- 规则：  
  - **有 Lactating 且（有 Prolactin 耐受或成瘾） ⇒ 视为药物诱发泌乳**  
  - 对这类泌乳可启用意识/操纵/移动的增益。

---

## 七、落地修改清单（代码视角）

实现本设计时，需在代码中做的关键调整（供将来对照，不是立即修改的具体步骤）：

1. **集中耐受函数**  
   - 在 `EqualMilkingSettings` 中实现并使用：
     - `GetProlactinTolerance(Pawn)`（保持现有签名）  
     - `GetProlactinToleranceFactor(Pawn)`  
     - `ApplyToleranceToBoost(float baseFactor, float toleranceSeverity)`
2. **水池进水重构**  
   - `HediffComp_EqualMilkingLactating.AddFromDrug(float rawSeverity)` 改为以“实际增量 \(\Delta s\)”为输入，使用 4.2 的公式。
3. **水池每日衰减统一**  
   - `GetDailyLactationDecay` 只通过 `GetProlactinToleranceFactor` 使用 4.3 的公式，不再出现任何旧的 `0.1×(1+耐受)` 样式。
4. **所有“*WithTolerance”函数改用统一公式**  
   - `GetMilkAmountFactorWithTolerance`  
   - `GetLactatingEfficiencyFactorWithTolerance`  
   - 以及基于它们的 `MilkGrowthTime`、额外饥饿/能耗等。
5. **成瘾逻辑选择方案**  
   - 依据 6.1 选择 A 或 B，并在代码中删除或简化 `HandleAddictionMechanics` 中对耐受的自定义倍率。

---

## 八、与旧设计的差异总结

- **不再在代码里“重新实现耐受增长/衰减”**：全部交给 RimWorld 原生 Chemical/Tolerance 机制与 XML 控制。
- **不再在不同功能点各写一套耐受公式**：统一用 `E_\text{tol}(t) = max(1 - t, E_{\min})`，集中在 `EqualMilkingSettings`。
- **水池 L 只关心“本次实际生效的药物强度”**，通过 \(\Delta s\) 与统一耐受系数转化为进水，而不是重复造一套与 vanilla 严重度脱节的“基础值/有效药效系数”逻辑。

