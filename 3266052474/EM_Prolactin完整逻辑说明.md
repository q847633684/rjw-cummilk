# EM_Prolactin（催乳素）完整逻辑说明

## 一、单次吃药触发的全部效果（每次都会执行）

每次使用一剂 EM_Prolactin，会**同时**触发下面所有效果（一次用药只判定一次成瘾）。

| 项目 | 效果 | 是否受耐受影响 | 说明 |
|------|------|----------------|------|
| **泌乳（Lactating）** | +0.5 严重度 | ✅ 耐受联动 | 高耐受时当次加的泌乳会变少 |
| **短期兴奋（EM_Prolactin_High）** | +0.75 严重度 | ✅ 耐受联动 | 愉悦 +5 心情，疼痛×0.9，意识 -10%，操纵/移动上限 50%；严重度每天 -1，约 1 天内消失 |
| **耐受（EM_Prolactin_Tolerance）** | +0.044 严重度 | ❌ 不加 | 按体型分摊（divideByBodySize），体型大加得少；每天自然 -0.015 |
| **娱乐（Joy）** | +0.3 需求 | ✅ 耐受联动 | 高耐受时当次加的 Joy 变少 |
| **成瘾判定** | 4% × (1 + 当前耐受严重度) | — | 仅当次用药判定一次；耐受 ≥ 0.03 才可能成瘾；已有成瘾则不再重复添加成瘾 hediff |
| **过量风险** | 游戏内药物过量系统 | — | 短时间多次用药可能触发 overdose（0.18～0.35 严重度偏移，1% 大过量） |

---

## 二、吃 1 次 / 2 次 / 3 次：哪些会叠加、哪些有上限

### 1. 泌乳（Lactating）——有上限 0.9999，永久由成瘾触发

- **合并规则**：未成瘾前，两剂 Lactating 相加**上限 0.9999**（不会单纯因“吃两次”就变永久）。**成瘾时**若当前有 Lactating 且 &lt;1，会**一次性提到 1.0**，且之后不再衰减 = 永久。
- **结果**：
  - **吃 1 次**：Lactating = **0.5**（临时，每天 -0.1 衰减）
  - **吃 2 次**：0.5 + 0.5 = 1.0 → 被压成 **0.9999**（仍是临时，会衰减）
  - **成瘾当次**：若已有 Lactating，严重度改为 **1.0**；之后**只有持续满足药物需求**（定期吃药）才维持不衰减，**戒断时**会按 -0.1/天 衰减，产奶加成下降。
- 所以：**维持永久 = 成瘾 + 持续用药**；断药戒断则泌乳会掉回去。吃 1 次 Lucilactin（+1.0）仍可直接永久（无需求维持）。

### 2. 耐受（EM_Prolactin_Tolerance）——每次都会叠

- **每次**吃药都 +0.044（按体型分摊），**会一直叠加**，上限 1.0。
- 每天自然 -0.015。
- **结果**：
  - **吃 1 次**：耐受 ≈ **0.044**（若之前为 0）
  - **吃 2 次**：≈ **0.088**
  - **吃 3 次**：≈ **0.132**
  - 连续吃很多次会接近 **1.0**；停用后慢慢掉回去。

### 3. 短期兴奋（EM_Prolactin_High）——会叠但顶多到 1.0

- 每次 +0.75，同一 hediff 会**合并**，上限 1.0；严重度每天 -1。
- **结果**：
  - **吃 1 次**：High = 0.75，约 0.75 天内消失
  - **短时间内吃 2 次**：0.75 + 0.75 → 压到 **1.0**，约 1 天内消失
  - **短时间内吃 3 次**：已经是 1.0，再加还是 1.0（不会超过 1.0）
- 负面（操纵/移动/意识）和心情 +5 在整个 High 存在期间都有，严重度越高只是持续时间更长，不加重单次强度。

### 4. 成瘾（EM_Prolactin_Addiction）——不叠，只判定一次

- **每次**吃药都会做一次**成瘾判定**：概率 = 4% × (1 + 当前耐受严重度)；且只有当前耐受 ≥ 0.03 才可能成瘾。
- **一旦**已经挂上成瘾 hediff，后面再吃**不会再叠第二个成瘾**，只会按游戏机制加重成瘾严重度（existingAddictionSeverityOffset 0.2 等）。
- 所以：吃 1 次、2 次、3 次是**多次抽奖**，不是“叠 3 层成瘾”。

### 5. 娱乐（Joy）——每次固定加一档

- 每次 +0.3 需求，**会叠**（同一需求条上多次加），没有“只加一次”的上限。
- 高耐受时**当次**加的 Joy 会被打折（耐受联动）。

### 6. 过量（Overdose）

- 游戏按**短时间内的药物摄入**算过量；EM_Prolactin 设置了 overdoseSeverityOffset 和 largeOverdoseChance。
- **吃 1 次**一般不会过量；**短时间内吃很多次**可能触发药物过量/大过量。

---

## 三、耐药性（耐受）对“下一次吃药”的影响

- **耐受**本身：每次吃药 +0.044（按体型），每天 -0.015，**会叠加**，上限 1.0。
- **耐受对下次药效的影响**（耐受联动）：
  - **泌乳、短期兴奋、Joy** 三条都绑了 `toleranceChemical`，所以**当前耐受越高，下次吃药时这三条当次效果越弱**（产奶加得少、High 加得少、Joy 加得少）。
  - **耐受条**和**成瘾判定**不受耐受联动：每次仍然 +0.044 耐受，成瘾仍然按 4%×(1+耐受) 判定。

因此：**吃越多、耐受越高 → 后面每次的“产奶/兴奋/Joy”越弱，但耐受和成瘾概率仍会继续涨。**

---

## 四、产量、产奶时间、吃饭量（和“吃几次”的关系）

这三项都由**当前 Lactating 的严重度**决定（公式里用连续 severity，0.25 一档）：

- **产奶量**：`基础产奶量 × milkAmountMultiplierPerStack^severity`（默认倍率 1；设置里调高后，severity 越高产奶越多）
- **产奶时间（间隔）**：`MilkIntervalDays / lactatingEfficiencyMultiplierPerStack^severity`（默认 1.25）：severity 越高，产奶越快、间隔越短
- **吃饭量（食物消耗）**：`hungerRateMultiplierPerStack^max(severity, 0.5)`（默认 1.31）：severity 越高，吃得越多

**每次吃药都会叠严重度（在 0.9999 上限内）**，所以：吃越多 → 严重度越高 → **产奶量、产奶速度、食物消耗**都一起增加。  
**和食物营养的关系**：多产奶 = 多耗营养。公式上**没有**“吃进去的营养直接换算成奶量”的一对一比例，但设计是：**severity 越高，饥饿倍率越高（吃得越多），产奶量和产奶速度也越高**，因此可以理解为“多吃的食物支撑多产的奶”——只是产奶量和速度随 severity 增加，食物消耗也随 severity 增加，整体成正比关系。

- **吃 1 次**：severity 0.5 → 产奶略快、食物约 +14%，**临时**
- **吃 2 次**：severity 0.9999 → 产奶更快、食物约 +31%，仍**临时**（会衰减）
- **成瘾时**：若已有 Lactating，严重度提到 1.0 → **永久**，产奶/食物按 1.0 档算
- **Lucilactin 一次**：+1.0 → 直接永久；之后可再叠 EM_Prolactin（受 maxLactationStacks 限制）

---

## 五、副作用汇总（按出现时机）

| 类型 | 何时出现 | 内容 |
|------|----------|------|
| **短期** | 每次吃药后 | 催乳素兴奋：意识 -10%，操纵/移动上限 50%，疼痛×0.9，心情 +5；约 1 天内消失 |
| **过量** | 短时间多次用药 | 游戏药物过量/大过量（0.18～0.35 严重度偏移，1% 大过量） |
| **戒断** | 成瘾且需求未满足 | 心情 -12，疼痛×2，休息变慢，饥饿 +50%，意识 -15%，进食 -20% |
| **长期** | 耐受 ≥ 0.6 且持续 | 肾脏损伤风险（ChemicalDamageModerate，MTB 约 180 天）；高耐受还会让后续药效（泌乳/兴奋/Joy）变弱 |

---

## 六、吃 1 次 / 2 次 / 3 次对照表（永久 = 成瘾触发）

| 项目 | 吃 1 次 | 吃 2 次 | 吃 3 次 |
|------|---------|---------|---------|
| **Lactating 严重度** | 0.5 | 0.9999（封顶） | 0.9999（同 2 次） |
| **是否永久泌乳** | 否 | 否（**成瘾且持续吃药才维持加成**） | 否（成瘾且持续吃药才维持） |
| **耐受** | +0.044 | 再 +0.044（累计约 0.088） | 再 +0.044（累计约 0.132） |
| **短期兴奋** | 0.75，约 0.75 天 | 可叠到 1.0，约 1 天 | 仍最多 1.0 |
| **产奶时间** | 略快（效率约 1.12） | 更快（约 1.25×） | 同 2 次 |
| **产奶量** | 基础×1 | 基础×1（默认） | 同 2 次 |
| **食物消耗** | 约 +14% | 约 +31% | 同 2 次 |
| **成瘾** | 抽一次 4%×(1+耐受) | 再抽一次 | 再抽一次 |

**结论**：  
- **泌乳**：合并上限 0.9999，**不会“吃两次就永久”**；**成瘾时**若已有 Lactating 会提到 1.0，但**需持续吃药满足需求才能维持产奶加成**，戒断时严重度会衰减。  
- **每次吃药**都会叠严重度（在 0.9999 内）→ 产奶量/产奶速度/食物消耗一起增加，多吃的食物与多产的奶成正比关系（severity 同时推高三者）。

---

## 七、永久泌乳条件：用成瘾判定，不用过量

### 为什么用成瘾而不是过量来判断永久？

- **过量**：代表“短时间用药过多”，结果是昏迷、脑损伤、死亡风险，是**惩罚**。若用“发生过量 = 永久”，等于鼓励玩家去踩一次过量才能永久，逻辑和体验都别扭。
- **成瘾**：代表“身体已依赖药物”，和“泌乳被固定下来”更一致——依赖药物 = 身体改变固定。用**成瘾**触发永久，逻辑顺畅：**成瘾时，若当前有 Lactating 且 &lt;1，则提到 1.0 且不再衰减**。

### 当前规则（成瘾 = 可维持永久，但需持续吃药）

- **合并**：未成瘾前，Lactating 合并**上限 0.9999**（不会单纯因吃两次就 ≥1）。
- **成瘾时**：若已有 Lactating，严重度设为 **1.0**；之后**需持续满足药物需求**（定期吃 EM_Prolactin）才能维持产奶加成不衰减；**戒断时**（需求未满足）泌乳严重度按 -0.1/天 衰减，加成下降。
- **变成/维持永久的方式**：  
  1. **成瘾且持续用药**：需求满足 → 泌乳不衰减，维持 1.0。  
  2. **吃 1 次 Lucilactin**：一次 +1.0 → 直接永久（无药物需求，不依赖维持）。  
- 挤奶 OnGathered 时**不会**再把 &lt;1 补到 1（只补到 0.9999）。

---

## 八、短期吃很多次触发过量的后果

游戏使用原版**药物过量**机制（Drug overdose hediff），短时间多次吃 EM_Prolactin 会累积过量严重度。

### 触发方式

- 每次用药增加过量严重度（overdoseSeverityOffset 0.18～0.35 随机，largeOverdoseChance 1% 可能大过量）。
- **吃 1 次**通常安全；**短时间内连续多剂**（例如同一天多剂）容易触发。

### 过量阶段与后果（原版）

| 阶段 | 严重度 | 后果 |
|------|--------|------|
| **隐藏** | &lt;50% | 无可见效果 |
| **轻度** | 50%～74% | 意识 -50%，约每 0.3 天呕吐 |
| **重度** | 75%～99% | 昏迷（意识上限 10%），脑部化学损伤（约 2.5 天 MTB），约 3 天内可能死亡 |
| **致命** | 100% | 立即死亡 |

过量严重度约**每天 -1**，不致命的话会逐渐恢复。  
**结论**：短期吃很多次 = 可能昏迷、呕吐、脑损伤甚至死亡，需避免连续滥用药。

---

## 九、整体系统建议

### 1. 平衡与数值

- **needLevelOffset**：成瘾后在 CompProperties_Drug 加 `needLevelOffset>1`，满足一次药能多顶一阵需求，减少“刚成瘾就戒断”的挫败感。
- **成瘾率/戒断**：若觉得成瘾太容易，可把 addictiveness 从 0.04 降到 0.02～0.03；若觉得戒断太轻，可把戒断心情改为 -15、疼痛改为 ×3。
- **耐受衰减**：当前 -0.015/天，长期不用会慢慢掉；若希望“戒断后更难再爽”，可略减衰减（如 -0.01）。

### 2. 体验与说明

- **药物描述**：在 EM_Prolactin 的 description 里写清：
  - **永久泌乳由成瘾触发**（成瘾时若正在泌乳会变为永久），不是“吃两次就永久”。
  - 每次吃药会叠产奶量/产奶速度/食物消耗（多吃的食物与多产的奶成正比）。
  - 短时间多次使用可能药物过量（昏迷、脑损伤、死亡）；耐受会降低后续药效。
- **提示**：高耐受或成瘾时，若能在 UI/提示里提示“药效减弱”或“需定期用药”，体验更好。

### 3. 可选机制（不必须）

- **产奶量倍率**：默认 1 时 severity 再高产奶量也不变；若希望“叠层后明显更多奶”，可在模组设置里把 milkAmountMultiplierPerStack 调到 &gt;1（如 1.1～1.2）。
- **过量阈值**：若觉得当前 0.18～0.35 太容易过量，可适当减小 overdoseSeverityOffset，或略降 largeOverdoseChance。

### 4. 代码与文档

- **永久 = 成瘾触发**：合并上限 0.9999；成瘾时若已有 Lactating 则设为 1.0 且成瘾期间不再衰减。
- 保持“一次用药只触发一次成瘾判定、耐受由 XML 统一加”的补丁逻辑。
- 产奶量/产奶速度/食物消耗均随 severity 增加，多吃的食物与多产的奶成正比（无单独“营养→奶量”公式，但 severity 同时提高三者）。
