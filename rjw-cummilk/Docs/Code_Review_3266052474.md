# 3266052474 代码与结构审阅报告

## 一、建筑与资源逻辑总览

### 1. 建筑数量与用途

| 类型 | defName | 逻辑概要 |
|------|--------|----------|
| **挤奶（牛奶/母乳）** | | |
| 挤奶点 | `EM_MilkingSpot` | 无存储、无电力；仅作为挤奶站位，产出的奶直接 `PlaceMilkThing` 落格。 |
| 手动挤奶泵 | `EM_MilkingPump` | 固定存储 Milk + EM_HumanMilk；同时为 Cumpilation 泄精目标（DeflateBucket）与精液收集建筑（FluidGatheringBuilding，范围 3）。 |
| 电动挤奶泵 | `EM_MilkingElectric` | 同上，需电力；DeflateBucket 效率更高；FluidGatheringBuilding 范围 4。 |
| **精液** | | |
| 精液桶 | `Cumpilation_CumBucket` | 仅存 Cumpilation_Cum；DeflateBucket + FluidGatheringBuilding（范围 3）；可链接床（CompCumBucketLink）。 |
| 高级精液桶 | `Cumpilation_Advanced_Cum_Bucket` | 存 Cumpilation_Cum + InsectJelly；被动收集（清洁范围内污物）、DeflateBucket + FluidGatheringBuilding；需电。 |
| 凳子+精液桶 | `stool_with_cumbucket` | 可坐 + DeflateBucket（泄精用）。 |
| 椅子+精液桶 | `chair_with_cumbucket` | 同上，舒适度更高。 |
| 自动椅+精液罐 | `autochair_with_cumtank` | 同上，需电。 |

**小结**：挤奶建筑 3 个（Spot / 手动泵 / 电动泵），精液专用建筑/家具 5 个；泵同时承担“挤奶存储”与“精液收集/泄精”。

---

### 2. 母乳（人奶）逻辑

- **产出**：人类/人形种族挤奶由 `JobDriver_EquallyMilk` + `CompEquallyMilkable.Gathered` 完成，产物由 `EqualMilkingSettings.GetMilkProductDef(pawn)` 决定，人形为 **EM_HumanMilk**。
- **污物**：`EM_HumanMilkFilth` 为人奶污物；清洁时由 `FluidGatheringDef`（`EM_HumanMilk_FromFilth`）按厚度回收为 **EM_HumanMilk**（无 fluidDef，仅 filth→thingDef）。
- **存储**：泵的 `fixedStorageSettings` / `defaultStorageSettings` 同时允许 `Milk` 与 `EM_HumanMilk`，即动物奶与人奶共用同一类建筑。

---

### 3. 牛奶（动物奶）逻辑

- **产出**：动物挤奶同一套 `JobDriver_EquallyMilk`，`GetMilkProductDef` 对动物返回原版 **Milk**（或 RJW 等覆盖后的 Def）。
- **与母乳**：同一 Job、同一建筑类型（泵/点），仅产物 Def 不同（Milk vs EM_HumanMilk）。

---

### 4. 精液逻辑

- **产出**：  
  - 性行为射精到带 `FluidGatheringBuilding` 的建筑（泵、精液桶、高级桶等）→ 产生 **Cumpilation_Cum**。  
  - 清洁精液污物时由 `FluidGatheringDef`（如 `Cumpilation_Basic_Cum_Gathering`）按配置产出 Cumpilation_Cum。  
  - 泄精（DeflateBucket）：Cumflation 等 hediff 在小人使用桶/泵/凳/椅时泄出，进入建筑库存。
- **消耗/规则**：食用 Cumpilation_Cum（及精液制品）的“谁可以吃”由 EqualMilking 的 **Producer Restrictions**（产主限制）统一管，与“谁可以吸奶/吃奶制品”同一套 UI（见下）。

---

## 二、报告与 UI 是否统一

### 报告 / 主表格

- **统一**：仅有一个主表 **Milk_PawnTable**（`MainTabWindow` → `Milk_PawnTable`），列包括：  
  Label、Gender、LifeStage、Pregnant、**Milk_MilkType**、**Milk_Lactating**、**Milk_Fullness**、允许手动挤奶/自挤/婴儿吸奶/成人吸奶、**Milk_ProducerRestrictions**、Milk_Dev。
- **Producer Restrictions** 列同时管：  
  - 女性：谁可以吸我的奶、谁可以吃我的奶制品；  
  - 男性：谁可以吃我的精液制品。  
  文案在 `EM.ProducerRestrictionsColumn` / `EM.ProducerRestrictionsColumnTip` 已统一说明。
- Cumpilation 没有单独再做一个“精液报告”或第二张 Pawn 表，**报告 UI 是统一的**。

### 其他 UI

- 设置界面见下节；精液桶“链接床”为单独弹窗（`Dialog_SelectBedForBucket`），与主表并列，逻辑清晰。

---

## 三、配置与设置是否统一

### 不统一：三套设置入口

当前存在 **3 个 Mod 子类**，即选项里会有 **3 个** 设置入口：

| Mod 类 | 设置类 | 菜单位 |
|--------|--------|--------|
| `EqualMilkingMod` | `EqualMilkingSettings` | "Equal Milking"（Equal_Milking.Translate()） |
| `Cumpilation_SettingsController` | `Cumpilation.Settings` | "Cumpilation - Base Settings"（cumpilation_settings_menuname） |
| `LeakCum_SettingsController` | `Cumpilation.Leaking.Settings` | "Cumpilation - Cum Leaking"（cumpilation_cumsettings_menuname） |

- EqualMilking：泌乳、挤奶、吸奶/奶制品限制、RJW 联动等。
- Cumpilation 主设置：Cumflation/Stuffing/Bukkake 开关与倍数、清洁收集、Oscillation、调试日志等。
- Cumpilation 泄精：污物生成、自动泄精到桶/清洁/随地、隐私、泄精倍数等。

**结论**：配置**未统一**——同一模组下三个独立设置页，对“一个 mod 一个设置入口”的常见预期不友好。建议中长期将 Cumpilation 两套并入 EqualMilking 的一个设置窗口（例如多 Tab 或折叠区）。

---

## 四、汉化是否统一

### Keyed

- **EqualMilking + 精液桶**：`Languages\ChineseSimplified\Keyed\lang.xml` 含 `Equal_Milking`、`EM.*`、`EM_CumBucket_*` 等，与英文 `lang.xml` 对应，**已汉化**。
- **Cumpilation 设置与 UI**：  
  - `Languages\English\Keyed\Mod_Settings.xml`：cumpilation_settings_*、cumpilation_cumsettings_*。  
  - `Languages\English\Keyed\UI_Elements.xml`：Cumpilation 的 UI 键。  
  - **ChineseSimplified / ChineseTraditional / Japanese** 下**没有**对应的 `Mod_Settings.xml`、`UI_Elements.xml`，即 Cumpilation 的设置项和部分 UI 在简中/繁中/日文下会**回退英文**。

**结论**：汉化**不统一**——主 mod 与精液桶已汉化；Cumpilation 设置与部分 UI 仅英文，需补简中/繁中/日文 Keyed。

### DefInjected / 其它

- DefInjected 按语言目录存在（如 EM_HumanMilkFilth、ThoughtDef 等），未做全键扫描，但主要 Def 名称/描述有对应语言文件即算一致；Cumpilation 的 Thought/Hediff 等若只在 English 下有 DefInjected，也会导致其他语言缺译。

---

## 五、发现的问题与不合理之处

### 1. 命名与拼写

- **HumanMilik.xml**：文件名拼写错误，应为 `HumanMilk.xml`（defName 已是 EM_HumanMilk，仅文件名错）。
- **Cumpilation.Settings**：`GlobaleBukkakeModifier` 应为 `GlobalBukkakeModifier`（多了一个 e）。

### 2. 设置与 Mod 结构

- **两个 Cumpilation Mod 类**：同一程序集内 `Cumpilation_SettingsController` 与 `LeakCum_SettingsController` 都继承 Mod，且各自 `GetSettings<Settings>()` 绑定不同 Settings 类。RimWorld 会为同一 ModContentPack 加载程序集中的 Mod 子类，结果就是两个额外设置入口；若希望“一个 mod 一个入口”，应只保留一个 Mod 子类（EqualMilkingMod），把 Cumpilation 设置并进去。
- **Cumpilation.Settings**：`EnableCumpilationDebugLogging` 的 `Scribe_Values.Look` 默认值为 `true`，通常“调试日志”默认应为 `false`，建议改为 `false`。

### 3. 代码与资源

- **PawnColumnDef Milk_Dev**：`<label>Lactating(Dev)</label>` 写死英文，未用 Keyed（如 `EM.Milk_Dev`），与其他列不统一。
- **命名空间**：Cumpilation 内存在两个 `Settings` 类（`Cumpilation.Settings` 与 `Cumpilation.Leaking.Settings`），阅读时需靠命名空间区分；若后续合并设置，可考虑合并为一个 Settings 类并按区域/Tab 组织字段。

### 4. 文档与注释

- **LactatingItems.xml**：`EM_Lucilactin` 的 description 为中文，其它 Def 多为英文或混合，风格不统一；若目标为多语言，description 应走 DefInjected 或 Keyed。
- **BuildingDefs.xml**：注释为中文（如“作为 Cumpilation 泄精目标”），与部分英文注释混用，可统一为一种或按需双语。

### 5. 逻辑与数据

- **Building_Milking**：仅负责“放置奶”和速度/产量偏移，不区分奶的类型；实际产物由 `CompEquallyMilkable` / `GetMilkProductDef` 决定，逻辑清晰。泵同时存 Milk 与 EM_HumanMilk，精液为 Cumpilation_Cum，无冲突。
- **精液桶链接床**：`CompCumBucketLink` 与 `Dialog_SelectBedForBucket` 仅英文/简中在 lang.xml 中有 EM_CumBucket_*，与上面 Keyed 结论一致。

### 6. 其它

- **PipeSystem**：注释写明“仅动物产出的原版 Milk 进入管道；人奶 EM_HumanMilk 与精液 Cumpilation_Cum 均不进入管道”，与当前 Def 设计一致。
- **RJW**：GetMilkProductDef_Prefix 等仅在 RJW 激活时加载，主模组不依赖 RJW 的 Def，结构合理。

---

## 六、建议优先级（简要）

| 优先级 | 项 | 说明 |
|--------|----|------|
| 高 | 汉化 Cumpilation 设置与 UI | 补简中/繁中/日文 `Mod_Settings.xml`、`UI_Elements.xml`（或合并进现有 Keyed），避免选项里大段英文。 |
| 高 | 设置入口统一（可选） | 将 Cumpilation 两套设置并入 EqualMilking 一个窗口（Tab 或折叠），并移除或弃用两个 Cumpilation Mod 类。 |
| 中 | 拼写与默认值 | 重命名 `HumanMilik.xml` → `HumanMilk.xml`；改 `GlobaleBukkakeModifier` → `GlobalBukkakeModifier`；`EnableCumpilationDebugLogging` 默认改为 false。 |
| 中 | Milk_Dev 列标签 | 改为 Keyed（如 EM.Milk_Dev），并在各语言 lang.xml 中补键。 |
| 低 | 注释与描述统一 | Def description 统一走多语言或统一中/英风格；BuildingDefs 等注释风格统一。 |

---

**总结**：  
- 建筑与母乳/牛奶/精液逻辑清晰，报告 UI 统一（一张表 + 产主限制列同时管奶与精液）。  
- 配置与汉化不统一：三套设置入口、Cumpilation 设置与部分 UI 未汉化；通过合并设置入口与补 Keyed/DefInjected 可明显改善体验与一致性。
